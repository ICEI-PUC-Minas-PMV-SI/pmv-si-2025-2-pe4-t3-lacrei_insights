<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lacrei SaÃºde Dashboard</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .dashboard-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 50px;
            width: 100%;
            max-width: 1200px;
            text-align: center;
        }

        .header { margin-bottom: 40px; }
        .header-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981, #3b82f6, #ef4444);
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 30px;
        }

        .header-icon::before { content: "ðŸ“Š"; font-size: 30px; }

        h1 { color: #1f2937; margin-bottom: 10px; font-size: 32px; font-weight: 700; }
        .subtitle { color: #6b7280; font-size: 16px; margin-bottom: 40px; }

        .buttons-container {
            display: flex; gap: 20px; justify-content: center;
            margin-bottom: 40px; flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 220px;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-atualizar {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }
        .btn-grafico {
            background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%);
            color: white;
        }

        .btn-icon { font-size: 20px; }

        .message {
            padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;
            font-size: 14px; display: none;
        }
        .message.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; display: block; }
        .message.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; display: block; }
        .message.info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; display: block; }

        /* CONTAINER DO METABASE */
        #metabaseContainer {
            width: 100%;
            margin-top: 30px;
            display: none;
        }

        #metabaseIframe {
            width: 100%;
            height: 1200px;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .loading {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>
<div class="dashboard-container">
    <div class="header">
        <div class="header-icon"></div>
        <h1>Lacrei SaÃºde Dashboard</h1>
        <p class="subtitle">Gerencie seus dados e visualize insights</p>
    </div>

    <div id="message" class="message"></div>

    <div class="buttons-container">
        <button class="btn btn-atualizar" id="btnAtualizar" onclick="atualizarBancoDados()">
            <span class="btn-icon">ðŸ”„</span>
            <span>Atualizar Banco de Dados</span>
        </button>

        <button class="btn btn-grafico" id="btnGrafico" onclick="mostrarGrafico()">
            <span class="btn-icon">ðŸ“ˆ</span>
            <span>Mostrar GrÃ¡fico</span>
        </button>
    </div>

    <!-- AQUI VAI O METABASE -->
    <div id="metabaseContainer">
        <iframe 
            id="metabaseIframe"
            src=""
            allowtransparency="true">
        </iframe>
    </div>

    <a href="/logout" class="logout-link">Sair</a>
</div>

<script>
    let iframeLoaded = false;

    function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = `message ${type}`;
        setTimeout(() => msg.className = 'message', 5000);
    }

    function setButtonLoading(id, loading) {
        const btn = document.getElementById(id);
        const icon = btn.querySelector('.btn-icon');
        btn.disabled = loading;
        icon.innerHTML = loading ? '<span class="loading"></span>' : (id === 'btnAtualizar' ? 'ðŸ”„' : 'ðŸ“ˆ');
    }

    async function atualizarBancoDados() {
        setButtonLoading('btnAtualizar', true);
        showMessage('Atualizando banco de dados...', 'info');

        try {
            const resp = await fetch('/upload/staging');
            const data = await resp.json();

            if (!resp.ok || data.sucesso === false) {
                showMessage(data.mensagem || 'Erro ao atualizar.', 'error');
                return;
            }

            showMessage('ETL concluÃ­do com sucesso!', 'success');

        } catch (e) {
            showMessage('Erro: ' + e.message, 'error');
        } finally {
            setButtonLoading('btnAtualizar', false);
        }
    }

    async function mostrarGrafico() {
        setButtonLoading('btnGrafico', true);
        showMessage('Carregando grÃ¡ficos do Metabaseâ€¦', 'info');

        try {
            // Chama seu pipeline BI
            await fetch('/upload/bi', { method: 'POST' });

            // Quando concluir, mostra o iframe do Metabase
            const iframe = document.getElementById("metabaseIframe");
            iframe.src = "http://localhost:3000/public/dashboard/edefb48d-1a91-423a-a048-803b6688c976";

            document.getElementById("metabaseContainer").style.display = "block";

            showMessage("GrÃ¡fico carregado com sucesso!", "success");

        } catch (e) {
            showMessage("Erro ao carregar o dashboard: " + e.message, "error");
        } finally {
            setButtonLoading('btnGrafico', false);
        }
    }
</script>

</body>
</html>
